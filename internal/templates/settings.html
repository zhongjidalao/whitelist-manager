{{ template "header.html" . }}

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-white">
                <h4 class="mb-0">系统设置</h4>
            </div>
            <div class="card-body">
                <form method="post">
                    <div class="mb-3">
                        <label class="form-label">云厂商（可多选）</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="provider_volcengine" name="providers" value="volcengine" {{ if .VolcEnabled }}checked{{ end }}>
                            <label class="form-check-label" for="provider_volcengine">Volcengine</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="provider_aws" name="providers" value="aws" {{ if .AWSEnabled }}checked{{ end }}>
                            <label class="form-check-label" for="provider_aws">AWS Lightsail</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="provider_aws_ec2" name="providers" value="aws-ec2" {{ if .AWSEC2Enabled }}checked{{ end }}>
                            <label class="form-check-label" for="provider_aws_ec2">AWS EC2</label>
                        </div>
                        <div class="form-text">可同时启用多个供应商；每个供应商使用独立配置。</div>
                    </div>

                    <div class="border rounded p-3 mb-3" id="volcengine_section">
                        <h6 class="mb-3">Volcengine 配置</h6>
                        <div class="mb-3">
                            <label for="volcengine_access_key" class="form-label">Volcengine Access Key ID</label>
                            <input type="text" class="form-control" id="volcengine_access_key" name="volcengine_access_key" value="{{ .Settings.AccessKey }}">
                        </div>
                        
                        <div class="mb-3">
                            <label for="volcengine_secret_key" class="form-label">Volcengine Secret Access Key</label>
                            <input type="password" class="form-control" id="volcengine_secret_key" name="volcengine_secret_key" value="{{ .Settings.SecretKey }}">
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="volcengine_region" class="form-label">区域 (Region)</label>
                                <input type="text" class="form-control" id="volcengine_region" name="volcengine_region" value="{{ .Settings.Region }}" placeholder="cn-beijing">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="volcengine_security_group_id" class="form-label">安全组 ID</label>
                                <input type="text" class="form-control" id="volcengine_security_group_id" name="volcengine_security_group_id" value="{{ .Settings.SecurityGroupID }}">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="volcengine_ports" class="form-label">管理端口 (多个用逗号分隔)</label>
                            <input type="text" class="form-control" id="volcengine_ports" name="volcengine_ports" value="{{ if .Settings.VolcenginePorts }}{{ .Settings.VolcenginePorts }}{{ else }}{{ .Settings.SSHPort }}{{ end }}" placeholder="22,8080">
                        </div>
                    </div>

                    <div class="border rounded p-3 mb-3" id="aws_common_section">
                        <h6 class="mb-3">AWS 通用配置</h6>
                        <div class="mb-3">
                            <label for="aws_access_key" class="form-label">AWS Access Key ID</label>
                            <input type="text" class="form-control" id="aws_access_key" name="aws_access_key" value="{{ .Settings.AWSAccessKey }}">
                        </div>
                        
                        <div class="mb-3">
                            <label for="aws_secret_key" class="form-label">AWS Secret Access Key</label>
                            <input type="password" class="form-control" id="aws_secret_key" name="aws_secret_key" value="{{ .Settings.AWSSecretKey }}">
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="aws_region" class="form-label">区域 (Region)</label>
                                <input type="text" class="form-control" id="aws_region" name="aws_region" value="{{ .Settings.AWSRegion }}" placeholder="ap-northeast-1">
                            </div>
                        </div>
                    </div>

                    <div class="border rounded p-3 mb-3" id="aws_lightsail_section">
                        <h6 class="mb-3">AWS Lightsail 配置</h6>
                        <div class="mb-3">
                            <label for="aws_instance_name" class="form-label">Lightsail 实例名称</label>
                            <input type="text" class="form-control" id="aws_instance_name" name="aws_instance_name" value="{{ .Settings.AWSInstanceName }}">
                        </div>
                        <div class="mb-3">
                            <label for="aws_ports" class="form-label">管理端口 (多个用逗号分隔)</label>
                            <input type="text" class="form-control" id="aws_ports" name="aws_ports" value="{{ if .Settings.AWSPorts }}{{ .Settings.AWSPorts }}{{ else }}{{ .Settings.SSHPort }}{{ end }}" placeholder="22,8080">
                        </div>
                    </div>

                    <div class="border rounded p-3 mb-3" id="aws_ec2_section">
                        <h6 class="mb-3">AWS EC2 配置</h6>
                        <div class="mb-3">
                            <label for="aws_ec2_security_group_id" class="form-label">EC2 安全组 ID</label>
                            <input type="text" class="form-control" id="aws_ec2_security_group_id" name="aws_ec2_security_group_id" value="{{ .Settings.AWSEC2SecurityGroupID }}">
                        </div>
                        <div class="mb-3">
                            <label for="aws_ec2_ports" class="form-label">管理端口 (多个用逗号分隔)</label>
                            <input type="text" class="form-control" id="aws_ec2_ports" name="aws_ec2_ports" value="{{ if .Settings.AWSEC2Ports }}{{ .Settings.AWSEC2Ports }}{{ else }}{{ .Settings.SSHPort }}{{ end }}" placeholder="22,8080">
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-text">密钥将明文保存在本地 SQLite 数据库中，请确保服务器安全。</div>
                    </div>

                    <div class="mb-3">
                        <label for="check_interval_value" class="form-label">检查间隔</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="check_interval_value" name="check_interval_value" value="{{ .CheckIntervalValue }}" required min="1">
                            <select class="form-select text-center" id="check_interval_unit" name="check_interval_unit" style="flex-grow: 0 !important; width: fit-content;">
                                <option value="seconds" {{ if eq .CheckIntervalUnit "seconds" }}selected{{ end }}>秒</option>
                                <option value="minutes" {{ if eq .CheckIntervalUnit "minutes" }}selected{{ end }}>分钟</option>
                                <option value="hours" {{ if eq .CheckIntervalUnit "hours" }}selected{{ end }}>小时</option>
                            </select>
                        </div>
                        <input type="hidden" id="check_interval_seconds" name="check_interval" value="{{ .Settings.CheckInterval }}">
                    </div>

                    <div class="mb-3">
                        <label for="ip_services" class="form-label">IP 查询服务列表</label>
                        <textarea class="form-control" id="ip_services" name="ip_services" rows="5" required>{{ .Settings.IPServices }}</textarea>
                        <div class="form-text">每行一个 URL，脚本会按顺序尝试获取公网 IP 地址。</div>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> 保存并重启任务
                    </button>
                    <a href="/" class="btn btn-secondary">取消</a>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    const intervalValueInput = document.getElementById('check_interval_value');
    const intervalUnitSelect = document.getElementById('check_interval_unit');
    const intervalSecondsInput = document.getElementById('check_interval_seconds');
    const providerVolcengineCheckbox = document.getElementById('provider_volcengine');
    const providerAWSCheckbox = document.getElementById('provider_aws');
    const providerAWSEC2Checkbox = document.getElementById('provider_aws_ec2');
    const volcengineSection = document.getElementById('volcengine_section');
    const awsCommonSection = document.getElementById('aws_common_section');
    const awsLightsailSection = document.getElementById('aws_lightsail_section');
    const awsEC2Section = document.getElementById('aws_ec2_section');
    const volcengineRequiredFields = [
        document.getElementById('volcengine_access_key'),
        document.getElementById('volcengine_secret_key'),
        document.getElementById('volcengine_region'),
        document.getElementById('volcengine_security_group_id'),
        document.getElementById('volcengine_ports')
    ];
    const awsCommonRequiredFields = [
        document.getElementById('aws_access_key'),
        document.getElementById('aws_secret_key'),
        document.getElementById('aws_region')
    ];
    const awsLightsailRequiredFields = [
        document.getElementById('aws_instance_name'),
        document.getElementById('aws_ports')
    ];
    const awsEC2RequiredFields = [
        document.getElementById('aws_ec2_security_group_id'),
        document.getElementById('aws_ec2_ports')
    ];

    function updateIntervalSeconds() {
        let value = parseInt(intervalValueInput.value);
        if (isNaN(value) || value < 1) {
            value = 1; // Default to 1 if invalid
        }

        const unit = intervalUnitSelect.value;
        let seconds = value;

        if (unit === 'minutes') {
            seconds = value * 60;
        } else if (unit === 'hours') {
            seconds = value * 3600;
        }
        intervalSecondsInput.value = seconds;
    }

    function setFieldsRequired(fields, required) {
        fields.forEach(field => {
            field.required = required;
        });
    }

    function updateProviderSections() {
        const volcEnabled = providerVolcengineCheckbox.checked;
        const awsLightsailEnabled = providerAWSCheckbox.checked;
        const awsEC2Enabled = providerAWSEC2Checkbox.checked;
        const awsCommonEnabled = awsLightsailEnabled || awsEC2Enabled;

        volcengineSection.style.display = volcEnabled ? '' : 'none';
        awsCommonSection.style.display = awsCommonEnabled ? '' : 'none';
        awsLightsailSection.style.display = awsLightsailEnabled ? '' : 'none';
        awsEC2Section.style.display = awsEC2Enabled ? '' : 'none';

        setFieldsRequired(volcengineRequiredFields, volcEnabled);
        setFieldsRequired(awsCommonRequiredFields, awsCommonEnabled);
        setFieldsRequired(awsLightsailRequiredFields, awsLightsailEnabled);
        setFieldsRequired(awsEC2RequiredFields, awsEC2Enabled);
    }

    intervalValueInput.addEventListener('input', updateIntervalSeconds);
    intervalUnitSelect.addEventListener('change', updateIntervalSeconds);
    providerVolcengineCheckbox.addEventListener('change', updateProviderSections);
    providerAWSCheckbox.addEventListener('change', updateProviderSections);
    providerAWSEC2Checkbox.addEventListener('change', updateProviderSections);

    // Initial update on page load
    updateIntervalSeconds();
    updateProviderSections();
</script>

{{ template "footer.html" . }}
